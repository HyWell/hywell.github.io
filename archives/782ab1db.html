<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="5vsdxt0Ys7MECgFw1ckoAA0_YGPFjDiWdmapA07suZA"><meta name="msvalidate.01" content="0362444C6E247177D0431A71020193B6"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css" integrity="sha256-no0c5ccDODBwp+9hSmV5VvPpKwHCpbVzXHexIkupM6U=" crossorigin="anonymous"><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js" integrity="sha256-a5YRB27CcBwBFcT5EF/f3E4vzIqyHrSR878nseNYw64=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"iassas.com","root":"/","images":"/images","scheme":"Mist","version":"8.7.0","exturl":true,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"disqusjs","storage":true,"lazyload":false,"nav":null,"activeClass":"disqusjs"},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":true,"preload":true}}</script><script src="/js/config.js"></script><meta name="description" content="在SQLMap原理分析(一)通过SQLMap的请求进行了一次简单的分析，大概了解SQLMap一个粗略的运行流程。这次通过源码的Debug进行深入一点研究。"><meta property="og:type" content="article"><meta property="og:title" content="SQLMap原理分析(二)"><meta property="og:url" content="https://iassas.com/archives/782ab1db.html"><meta property="og:site_name" content="海上孤岛"><meta property="og:description" content="在SQLMap原理分析(一)通过SQLMap的请求进行了一次简单的分析，大概了解SQLMap一个粗略的运行流程。这次通过源码的Debug进行深入一点研究。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2ed407c05.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2eec3ac6a.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2f556aa4b.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2eecea60d.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2f54bbdba.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2eeb99d73.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2eecc3af6.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2eed053b4.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2eecea051.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2eec3b6ea.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2eed06b5e.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2f5605d4b.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2f55cf740.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2f561842f.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2f55d1102.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2f55e3e92.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2f555cfc4.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2f558f816.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd2f5583e99.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd307501870.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd3075e0add.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd3075de50a.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd3075ce2c5.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd3074bd00b.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd3075dfc04.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd3075cc469.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd3075db5a4.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd3075cb1c8.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd3075a7b0a.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd30c3e1ed1.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd30c433f5d.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd30c3b927a.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd30c3e2e76.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd30c463356.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd30c486dcd.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd30c458928.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd30c3e0fdc.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd30c3e00ac.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd30c466091.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd3101f21d1.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd311092e00.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd311093db6.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd311094d32.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd31107da75.png"><meta property="og:image" content="https://i.loli.net/2019/05/04/5ccd311081b0f.png"><meta property="article:published_time" content="2019-05-04T06:29:44.000Z"><meta property="article:modified_time" content="2019-05-15T11:50:58.000Z"><meta property="article:author" content="Hywell"><meta property="article:tag" content="工具"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://i.loli.net/2019/05/04/5ccd2ed407c05.png"><link rel="canonical" href="https://iassas.com/archives/782ab1db.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://iassas.com/archives/782ab1db.html","path":"archives/782ab1db.html","title":"SQLMap原理分析(二)"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>SQLMap原理分析(二) | 海上孤岛</title><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-104316961-1","only_pageview":true}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?c905063ab2716ed0beb4a1a401edf4fc"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/atom.xml" title="海上孤岛" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">海上孤岛</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">化身孤岛的鲸</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%87%86%E5%A4%87"><span class="nav-number">1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Debug"><span class="nav-number">2.</span> <span class="nav-text">Debug</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%A3%80%E6%B5%8B"><span class="nav-number">2.1.</span> <span class="nav-text">连接检测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WAF%E5%88%A4%E6%96%AD"><span class="nav-number">2.2.</span> <span class="nav-text">WAF判断</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%B5%8B"><span class="nav-number">2.2.1.</span> <span class="nav-text">检测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%86%E5%88%AB"><span class="nav-number">2.2.2.</span> <span class="nav-text">识别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A8%B3%E5%AE%9A%E6%80%A7%E6%A3%80%E6%B5%8B"><span class="nav-number">2.3.</span> <span class="nav-text">稳定性检测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E6%95%B0%E5%8A%A8%E6%80%81%E6%A3%80%E6%B5%8B"><span class="nav-number">2.4.</span> <span class="nav-text">参数动态检测</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%85%A5%E6%A3%80%E6%B5%8B"><span class="nav-number">2.5.</span> <span class="nav-text">注入检测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E5%88%A4%E6%96%AD"><span class="nav-number">2.5.1.</span> <span class="nav-text">简单判断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%B1%E5%BA%A6%E5%88%A4%E6%96%AD"><span class="nav-number">2.5.2.</span> <span class="nav-text">深度判断</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Hywell" src="/images/avatar.png"><p class="site-author-name" itemprop="name">Hywell</p><div class="site-description" itemprop="description">寻找诗和远方</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">44</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">27</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="sidebar-button site-overview-item animated"><button class="js-gitter-toggle-chat-button"><i class="fa fa-comment"></i> Chat</button></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2h5d2VsbA==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hywell"><i class="fab fa-github fa-fw"></i></span> </span><span class="links-of-author-item"><span class="exturl" data-url="bWFpbHRvOmh5d2VsbC4yOEBnbWFpbC5jb20=" title="E-Mail → mailto:hywell.28@gmail.com"><i class="fa fa-envelope fa-fw"></i></span></span></div><div class="cc-license site-overview-item animated" itemprop="license"><span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></span></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cDovL3d3dy5jaGluYWJhaWtlci5jb20vZm9ydW0ucGhw" title="http:&#x2F;&#x2F;www.chinabaiker.com&#x2F;forum.php">Chinabaike</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cDovL2tvbmdkZXdlaS5jbi8=" title="http:&#x2F;&#x2F;kongdewei.cn&#x2F;">caomei</span></li></ul></div></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://iassas.com/archives/782ab1db.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="Hywell"><meta itemprop="description" content="寻找诗和远方"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="海上孤岛"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">SQLMap原理分析(二)</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-05-04 14:29:44" itemprop="dateCreated datePublished" datetime="2019-05-04T14:29:44+08:00">2019-05-04</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-05-15 19:50:58" itemprop="dateModified" datetime="2019-05-15T19:50:58+08:00">2019-05-15</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/" itemprop="url" rel="index"><span itemprop="name">安全研究</span></a> </span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>3.5k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>3 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><p>在<a href="/archives/e409b646.html" title="SQLMap原理分析(一)">SQLMap原理分析(一)</a>通过SQLMap的请求进行了一次简单的分析，大概了解SQLMap一个粗略的运行流程。这次通过源码的Debug进行深入一点研究。</p><span id="more"></span><h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>这里使用pycharm进行debug，打开SQLMap项目之后，在【Run】-【Edit Configurations】设置参数：-u <span class="exturl" data-url="aHR0cDovL3Rlc3Rhc3AudnVsbndlYi5jb20vc2hvd2ZvcnVtLmFzcD9pZD0w">http://testasp.vulnweb.com/showforum.asp?id=0<i class="fa fa-external-link-alt"></i></span> –flush-session。由于上次跑了testasp这个站点有缓存因此加上了–flush-session。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2ed407c05.png" alt="pycharm-config.png"></p><h1 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h1><h2 id="连接检测"><a href="#连接检测" class="headerlink" title="连接检测"></a>连接检测</h2><p>准备工作做好之后，在sqlmapy.py文件第407行下一个断点，然后开启Debug之旅。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2eec3ac6a.png" alt="debug-1.png"></p><p>可以看到现在已经成功断到407行了，单步步入到main()函数中。发现前面几行代码是获取配置、路径、banner等信息。当运行到136行的时候可以发现已经获取到前面设置的站点参数。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2f556aa4b.png" alt="debug-2.png"></p><p>运行到156行步入到init()函数中，2629行至后面可以看到会进行一系列设置：http、threads等等。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2eecea60d.png" alt="debug-3.png"></p><p>步出回到sqlmapy.py中的main函数，继续单步运行会进行一系列判断检查，直到177行会发现start函数，步入到start函数。这时候会来到./lib/core/decorators.py的stackedmethod函数，根据注释，该函数是用来堆栈对齐的回退函数（不太理解啥意思）。看到result关键字直接步入。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2f54bbdba.png" alt="debug-4.png"></p><p>发现来到./lib/controller/controller.py的start函数。根据注释可以得知，该函数用来检查url、请求方式、cookie以及是否存在注入等。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2eeb99d73.png" alt="debug-5.png"></p><p>经过一系列的信息获取：Method、paramKey、Headers等，来到了420行进行连接等检查。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2eecc3af6.png" alt="debug-6.png"></p><p>跟进checkConnection函数，会来到./controller/checks.py。先检查hostname是否是ip形式（xxx.xxx.xxx.xxx），之后检查有没有设置代理。然后输出log信息：尝试连接目标url。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2eed053b4.png" alt="debug-7.png"></p><p>终端上这时候print出该条日志信息。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2eecea051.png" alt="log-print.png"></p><p>在1589行可以看到开始进行request请求，跟进Request函数，来到./request/connect.py，通过注释可以得知queryPage函数是用来获取目标url页面内容。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2eec3b6ea.png" alt="debug-8.png"></p><p>直到1306行调用Connect.getPage发起请求开始获取页面内容。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2eed06b5e.png" alt="debug-9.png"></p><p>步入getPage函数，经过一系列的赋值：url、get类型参数、cookie等。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2f5605d4b.png" alt="debug-10.png"></p><p>497行调用urllib.request.urlopent发起请求。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2f55cf740.png" alt="debug-11.png"></p><p>515行获取响应正文信息，这跟上篇文章请求第一个请求包相呼应。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2f561842f.png" alt="debug-12.png"></p><p>570行会关闭连接。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2f55d1102.png" alt="debug-13.png"></p><p>最后getPage函数会return出响应正文、响应头以及响应状态码。继续运行回到queryPage函数，经过一系列处理queryPage函数将响应正文、响应头以及响应状态码也return出去。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2f55e3e92.png" alt="debug-14.png"></p><p>之后会来到./lib/core/decorators.py，会将获取到的result返回。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2f555cfc4.png" alt="debug-15.png"></p><p>会回到checks.py，最终返回True。这时候SQLMap已经获知目标站点可连接。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2f558f816.png" alt="debug-16.png"></p><h2 id="WAF判断"><a href="#WAF判断" class="headerlink" title="WAF判断"></a>WAF判断</h2><p>之后会开始进行WAF检测&amp;识别。</p><h3 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h3><p>在423行进行waf检测。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd2f5583e99.png" alt="debug-17.png"></p><p>跟进checkWaf函数，又会来到stackedmethod函数，直接到在result进行步入，会来到checkWaf函数。根据注释可以得知sqlmap的waf检测能力来源nmap的http-waf-detect脚本。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd307501870.png" alt="debug-18.png"></p><p>首先将几种攻击类型的payload（SQL注入、目录遍历、XSS等）拼接到已有参数发起请求。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd3075e0add.png" alt="debug-19.png"></p><p>如果直接连接错误，可以判断存在WAF。若可正常连接，判断不存在WAF。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd3075de50a.png" alt="debug-20.png"></p><h3 id="识别"><a href="#识别" class="headerlink" title="识别"></a>识别</h3><p>继续执行可以看到identifyWaf函数，但由于并未设置检测waf会被判断跳过。可以按住command点击identifyWaf函数跟进查看原理。大概原理是调用waf文件夹下脚本进行检测-得到结果。脚本脚本大概逻辑为：发起请求-获取响应正文、响应头、响应码-根据规则判断-返回结果。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd3075ce2c5.png" alt="debug-21.png"></p><h2 id="稳定性检测"><a href="#稳定性检测" class="headerlink" title="稳定性检测"></a>稳定性检测</h2><p>回到controller运行至436行会有checkStability函数。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd3074bd00b.png" alt="debug-22.png"></p><p>跟进该函数，通过备注发现该函数是用来进行稳定性检测。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd3075dfc04.png" alt="debug-23.png"></p><h2 id="参数动态检测"><a href="#参数动态检测" class="headerlink" title="参数动态检测"></a>参数动态检测</h2><p>经过一系列赋值&amp;判断，运行至535行步入checkDynParam函数，根据注释可以得知该函数是用来检测参数是否为动态。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd3075cc469.png" alt="debug-24.png"></p><h2 id="注入检测"><a href="#注入检测" class="headerlink" title="注入检测"></a>注入检测</h2><h3 id="简单判断"><a href="#简单判断" class="headerlink" title="简单判断"></a>简单判断</h3><p>运行至558行，终于来到关键的注入检测。跟进heuristicCheckSqlInjection函数，在1023行进行随机字符串获取，随机字符串长度为10。并且该随机字符串需满足单引号或者双引号出现次数为1。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd3075db5a4.png" alt="debug-25.png"></p><p>接下来将随机字符串拼接成payload，发起请求。这个请求跟上篇文章请求中的注入判断请求包对应。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd3075cb1c8.png" alt="debug-26.png"></p><p>1035行调用parseFilePaths函数检测响应正文中是否包含绝对路径。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd3075a7b0a.png" alt="debug-27.png"></p><p>1036行检测上一个响应是否有数据库错误信息，这时候的上个请求payload是包含单双引号的，通过这种方式可以极快的判断是否存在注入。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd30c3e1ed1.png" alt="debug-28.png"></p><p>由于这里并不会有数据库的报错信息，所以还需要继续运行。在1092行会生成两个随机变量，长度为6。接下来生成带&lt;’&quot;&gt;的payload，该payload为第一个随机字符串加上&lt;’&quot;&gt;加上第二个随机字符串。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd30c433f5d.png" alt="debug-29.png"></p><p>1095行出现agent.payload函数，跟进该函数（./lib/core/agent.py），根据注释得知该函数功能是替换SQL注入参数。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd30c3b927a.png" alt="debug-30.png"></p><p>166行调用cleanupPayload函数，根据函数名猜测该函数主要是用来进行payload清理。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd30c3e2e76.png" alt="debug-31.png"></p><p>最终返回经过处理之后的payload:<br><code>u&#39;id=__PAYLOAD_DELIMITER__0\&#39;ozeyed&lt;\&#39;&quot;&gt;cOuFpj__PAYLOAD_DELIMITER__&#39;</code>。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd30c463356.png" alt="debug-32.png"></p><p>之后使用处理之后的payload发起请求。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd30c486dcd.png" alt="debug-33.png"></p><p>最后返回kb.heuristicTest。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd30c458928.png" alt="debug-34.png"></p><p>继续运行回到start函数，570行调用checkSqlInjection开始进行注入检测。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd30c3e0fdc.png" alt="debug-35.png"></p><p>跟进checkSqlInjection函数，调用InjectionDict函数设置注入字典，之后对参数值类型进行检查。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd30c3e00ac.png" alt="debug-36.png"></p><p>135行调用getSortedInjectionTests函数获取待注入类型及其payload等信息。142行会将tests数据取出来，直至取完才能跳出141行的while循环。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd30c466091.png" alt="debug-37.png"></p><p>148行由于条件并不满足，会跳过dbms检测。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd3101f21d1.png" alt="debug-38.png"></p><p>之后对payload进行处理，直至506、511行调用Request.queryPage请求。这时候的payload包含AND关键字。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd311092e00.png" alt="debug-39.png"></p><p>之后对结果进行判断，由于并没有满足条件，许多判断都直接pass掉。开始重新构造payload发起请求。直至payload为boolen类型注入，会进入判断设置injectable = True。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd311093db6.png" alt="debug-40.png"></p><p>拆分一下这里的判断逻辑：</p><ol><li>falsePage与truePage是否相等，falsePage使用的payload为cmpPayload、TruePage使用的payload为reqPayload。假设得到结果为A，A为布尔类型；</li><li>获取not kb.nullConnection结果，假设得到结果为B，B为布尔类型；</li><li>判断not(A and B)，假设得到结果为C，C为布尔类型；</li><li>判断trueResult and C，假设得到结果为D，只有trueResult、C同为True。D才能为True，满足条件判断；</li><li>正常情况下B为True，这时候只有falsePage不等于truePage，才能满足条件。</li></ol><p><img data-src="https://i.loli.net/2019/05/04/5ccd311094d32.png" alt="debug-41.png"></p><p>这时候的判断还是比较简单的判断并不能直接就认为该处存在注入，可以看到终端输出时该处似乎是布尔类型的盲注。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd31107da75.png" alt="debug-42.png"></p><p>之后对该注入信息进行赋值存储injection变量中。由于这时候injectable为True，所以会跳出372行的for循环。</p><p><img data-src="https://i.loli.net/2019/05/04/5ccd311081b0f.png" alt="debug-43.png"></p><h3 id="深度判断"><a href="#深度判断" class="headerlink" title="深度判断"></a>深度判断</h3><p>待定。</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>SQLMap整个运行机制：</p><ol><li>获取url、thread、headers等信息存储至变量中；</li><li>网站存活性检测；</li><li>WAF检测&amp;WAF类型识别；</li><li>稳定性检测；</li><li>注入检测。</li></ol><p>SQLMap关键的脚本：</p><ol><li>./lib/core/decorators.py</li><li>./lib/controller/controller.py</li><li>./request/connect.py</li><li>./controller/checks.py</li><li>./lib/core/agent.py</li></ol><p>通过SQLMap机制简单分析，后续在手工注入的时候可以参考SQLMap的判断机制。</p></div><div class="popular-posts-header">相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/260d9dca.html" rel="bookmark">IDA动态调试-ELF</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/e409b646.html" rel="bookmark">SQLMap原理分析(一)</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/c5863b38.html" rel="bookmark">BurpSuitePro 2.1及之后版本通杀加载器</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/4afab831.html" rel="bookmark">jar文件打包成app</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/archives/221b42d4.html" rel="bookmark">使用electron-build打包</a></div></li></ul><footer class="post-footer"><div class="reward-container"><div>来杯星巴克～～</div><button>赞赏</button><div class="post-reward"><div><img src="/images/wechatpay.jpg" alt="Hywell 微信"> <span>微信</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>Hywell</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://iassas.com/archives/782ab1db.html" title="SQLMap原理分析(二)">https://iassas.com/archives/782ab1db.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div><div class="followme"><span>欢迎关注我的其它发布渠道</span><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="/images/Wechat.jpg"><span class="icon"><i class="fab fa-weixin"></i> </span><span class="label">WeChat</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i> </span><span class="label">RSS</span></a></div></div></div><div class="post-tags"><a href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag"><i class="fa fa-tag"></i> 工具</a></div><div class="post-widgets"><div class="wp_rating"><div id="wpac-rating"></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/archives/e409b646.html" rel="prev" title="SQLMap原理分析(一)"><i class="fa fa-chevron-left"></i> SQLMap原理分析(一)</a></div><div class="post-nav-item"><a href="/archives/8592a171.html" rel="next" title="渗透测试-响应加密SQL注入">渗透测试-响应加密SQL注入 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="disqus_thread"><noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Hywell</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">245k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">3:43</span></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script><script src="https://embed.widgetpack.com/widget.js" async></script><script class="next-config" data-name="rating" type="application/json">{"enable":true,"id":25178,"color":"#fc6423"}</script><script src="/js/third-party/rating.js"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="gitter" type="application/json">{"enable":true,"room":"blogChat/community"}</script><script src="/js/third-party/chat/gitter.js"></script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script><script class="next-config" data-name="nprogress" type="application/json">{"enable":true,"spinner":true}</script><script src="/js/third-party/nprogress.js"></script><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@1.3.0/dist/disqusjs.css" integrity="sha256-GxdCIOyfxQ1OBfS99qAIJDoGK1ADuBsxhMTqXG82fAY=" crossorigin="anonymous"><script class="next-config" data-name="disqusjs" type="application/json">{"enable":true,"api":"https://disqus.com/api/","apikey":"4K9xpN3xbZQxMY8D7pQLoq1HvzKJgzLYILVkK34jNdsgRhS2Wkkhpesc8WZeBIhi","shortname":"iassas","js":{"url":"https://cdn.jsdelivr.net/npm/disqusjs@1.3.0/dist/disqus.js","integrity":"sha256-LVaMHPQ2zLqOc5rXSAfr4d1PIkEGNLyyUTDNPZmTtUw="}}</script><script src="/js/third-party/comments/disqusjs.js"></script></body></html>